name: Publish Helm Chart

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      chart_version:
        description: 'Chart version to publish (leave empty to use Chart.yaml version)'
        required: false
        type: string
      release_tag:
        description: 'Release tag to use as app version (leave empty to use latest commit SHA)'
        required: false
        type: string

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Log in to GHCR
        env:
          HELM_EXPERIMENTAL_OCI: 1
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Determine chart tag
        id: vars
        run: |
          # Use the chart's own version from Chart.yaml
          CHART_FILE="chart/proxmox-name-sync-controller/Chart.yaml"
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            # Manual dispatch - use inputs or defaults
            if [[ -n "${{ github.event.inputs.chart_version }}" ]]; then
              CHART_VERSION="${{ github.event.inputs.chart_version }}"
            else
              CHART_VERSION=$(grep '^version:' "$CHART_FILE" | awk '{print $2}')
            fi
            
            if [[ -n "${{ github.event.inputs.release_tag }}" ]]; then
              RELEASE_TAG="${{ github.event.inputs.release_tag }}"
            else
              RELEASE_TAG="${{ github.sha }}"
            fi
            
            echo "Manual promotion triggered"
          else
            # Release event - use chart version and release tag
            CHART_VERSION=$(grep '^version:' "$CHART_FILE" | awk '{print $2}')
            RELEASE_TAG="${{ github.event.release.tag_name }}"
            echo "Release triggered"
          fi
          
          echo "chart_version=${CHART_VERSION}" >> "$GITHUB_OUTPUT"
          echo "release_tag=${RELEASE_TAG}" >> "$GITHUB_OUTPUT"
          echo "Publishing chart version: $CHART_VERSION with app version: $RELEASE_TAG"
          echo "Note: Chart versions are validated on PRs to prevent overwrites"

      - name: Get chart name and dir
        id: chart
        run: |
          CHART_DIR="chart/proxmox-name-sync-controller"
          CHART_NAME=$(grep '^name:' "$CHART_DIR/Chart.yaml" | awk '{print $2}')
          echo "dir=${CHART_DIR}" >> "$GITHUB_OUTPUT"
          echo "name=${CHART_NAME}" >> "$GITHUB_OUTPUT"

      - name: Package chart
        run: |
          mkdir -p dist
          helm dependency build "${{ steps.chart.outputs.dir }}" || true
          helm package "${{ steps.chart.outputs.dir }}" \
            --version "${{ steps.vars.outputs.chart_version }}" \
            --app-version "${{ steps.vars.outputs.release_tag }}" \
            --destination dist

      - name: Push chart to GHCR
        run: |
          USERNAME=$(echo "${{ github.repository }}" | cut -d'/' -f1 | tr '[:upper:]' '[:lower:]')
          helm push "dist/${{ steps.chart.outputs.name }}-${{ steps.vars.outputs.chart_version }}.tgz" "oci://ghcr.io/${USERNAME}/charts"
