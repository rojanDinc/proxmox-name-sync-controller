name: Publish Helm Chart

on:
  push:
    branches:
      - main
    paths:
      - "chart/**"
      - ".github/workflows/chart-publish.yml"
  release:
    types: [published]

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Log in to GHCR
        env:
          HELM_EXPERIMENTAL_OCI: 1
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Determine chart tag
        id: vars
        run: |
          if [[ "${{ github.event_name }}" == "release" ]]; then
            # For releases, use the release tag
            TAG="${{ github.event.release.tag_name }}"
            echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
            echo "push_latest=false" >> "$GITHUB_OUTPUT"
          else
            # For main branch pushes, use first 5 chars of commit SHA
            TAG="$(echo "${GITHUB_SHA}" | cut -c1-5)"
            echo "tag=${TAG}" >> "$GITHUB_OUTPUT"
            echo "push_latest=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Get chart name and dir
        id: chart
        run: |
          CHART_DIR="chart/proxmox-name-sync-controller"
          CHART_NAME=$(grep '^name:' "$CHART_DIR/Chart.yaml" | awk '{print $2}')
          echo "dir=${CHART_DIR}" >> "$GITHUB_OUTPUT"
          echo "name=${CHART_NAME}" >> "$GITHUB_OUTPUT"

      - name: Package chart
        run: |
          mkdir -p dist
          helm dependency build "${{ steps.chart.outputs.dir }}" || true
          helm package "${{ steps.chart.outputs.dir }}" \
            --version "${{ steps.vars.outputs.tag }}" \
            --app-version "${{ steps.vars.outputs.tag }}" \
            --destination dist

      - name: Push chart to GHCR
        run: |
          helm push "dist/${{ steps.chart.outputs.name }}-${{ steps.vars.outputs.tag }}.tgz" "oci://ghcr.io/${{ github.repository }}"

      - name: Push latest tag for main branch
        if: steps.vars.outputs.push_latest == 'true'
        run: |
          # Create a copy of the chart with 'latest' version
          helm package "${{ steps.chart.outputs.dir }}" \
            --version "latest" \
            --app-version "${{ steps.vars.outputs.tag }}" \
            --destination dist
          helm push "dist/${{ steps.chart.outputs.name }}-latest.tgz" "oci://ghcr.io/${{ github.repository }}"


